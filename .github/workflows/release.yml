name: Release Workflow

on:
  workflow_call:
    secrets:
      GITHUB_TOKEN:
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - name: Create release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v$(jq -r '.version' package.json)
        release_name: Release v$(jq -r '.version' package.json)
        body: |
          $(sed -n "/## Version $(jq -r '.version' package.json | sed 's/\./\\\./g')/,/##/p" CHANGELOG.md | sed '1d;/^##/d')
        draft: false
        prerelease: false
    - name: Publish release
      uses: actions/github-script@v4
      with:
        script: |
          const { owner, repo } = context.repo;
          const response = await github.repos.listReleases({ owner, repo, per_page: 1, draft: false, });
          const latestRelease = response.data[0];
          await github.repos.updateRelease({ owner, repo, release_id: latestRelease.id, draft: false, prerelease: false });
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}